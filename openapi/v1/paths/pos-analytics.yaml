paths:
  /tenants/{tenantId}/analytics/pos/overview:
    post:
      tags: [POS Analytics]
      summary: Get POS overview metrics for a specific date
      description: |
        Returns comprehensive POS metrics including:
        - Total revenue
        - Total transactions
        - Average ticket size
        - Top cashier
        - Best selling product
        
        Phase 4A+: Now supports historical comparison with previous periods.
        When comparison_period is provided, returns variance between current and previous period.
      operationId: getPosOverview
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                date:
                  type: string
                  format: date
                  description: Date to fetch metrics for (YYYY-MM-DD). Defaults to last 30 days.
                  example: "2025-01-15"
                comparison_period:
                  type: string
                  enum: [previous_day, previous_week, previous_month, previous_year]
                  description: Compare with previous period (Phase 4A+ Historical Comparison)
                  example: "previous_month"
      responses:
        '200':
          description: POS overview metrics with optional comparison
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      current:
                        type: object
                        description: Current period metrics
                        properties:
                          total_revenue:
                            type: number
                            format: float
                            description: Total revenue for the specified date
                            example: 12500000
                          total_transactions:
                            type: integer
                            description: Total number of transactions
                            example: 85
                          average_ticket:
                            type: number
                            format: float
                            description: Average transaction value
                            example: 147058.82
                          top_cashier:
                            type: object
                            nullable: true
                            properties:
                              id:
                                type: string
                                format: uuid
                              name:
                                type: string
                                example: "John Doe"
                              transactions:
                                type: integer
                                example: 45
                              revenue:
                                type: number
                                format: float
                                example: 6500000
                          best_product:
                            type: object
                            nullable: true
                            properties:
                              id:
                                type: string
                                format: uuid
                              name:
                                type: string
                                example: "Kopi Susu"
                              sku:
                                type: string
                                example: "KOP-001"
                              units_sold:
                                type: integer
                                example: 150
                              revenue:
                                type: number
                                format: float
                                example: 750000
                      comparison:
                        type: object
                        nullable: true
                        description: Previous period metrics (only when comparison_period is provided)
                        properties:
                          total_revenue:
                            type: number
                            format: float
                            example: 11000000
                          total_transactions:
                            type: integer
                            example: 78
                          average_ticket:
                            type: number
                            format: float
                            example: 141025.64
                          top_cashier:
                            type: object
                            nullable: true
                          best_product:
                            type: object
                            nullable: true
                      variance:
                        type: object
                        nullable: true
                        description: Percentage change between current and comparison (Phase 4A+)
                        properties:
                          revenue_change:
                            type: number
                            format: float
                            description: Percentage change in revenue
                            example: 13.64
                          transactions_change:
                            type: number
                            format: float
                            description: Percentage change in transactions
                            example: 8.97
                          average_ticket_change:
                            type: number
                            format: float
                            description: Percentage change in average ticket
                            example: 4.28
        '401':
          description: Unauthorized
        '403':
          description: Forbidden - User doesn't have permission to view analytics
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/trends:
    post:
      tags: [POS Analytics]
      summary: Get POS sales trends over time
      description: |
        Returns sales trends data for charting.
        Supports daily, weekly, or monthly aggregation.
      operationId: getPosTrends
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                period:
                  type: string
                  enum: [day, week, month]
                  default: week
                  description: Aggregation period
                  example: "week"
                start_date:
                  type: string
                  format: date
                  description: Start date for trend analysis (defaults to 7 days ago for 'day', 4 weeks ago for 'week', 6 months ago for 'month')
                  example: "2025-01-01"
                end_date:
                  type: string
                  format: date
                  description: End date for trend analysis (defaults to today)
                  example: "2025-01-15"
      responses:
        '200':
          description: Sales trends data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                          example: "2025-01-15"
                        revenue:
                          type: number
                          format: float
                          example: 12500000
                        transactions:
                          type: integer
                          example: 85
                        average_ticket:
                          type: number
                          format: float
                          example: 147058.82
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/best-sellers:
    post:
      tags: [POS Analytics]
      summary: Get best selling products
      description: |
        Returns top performing products sorted by revenue or quantity.
        Includes profit margin for recipe-based products.
      operationId: getPosBestSellers
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                limit:
                  type: integer
                  minimum: 1
                  maximum: 100
                  default: 10
                  description: Maximum number of products to return
                  example: 10
                sort_by:
                  type: string
                  enum: [revenue, quantity]
                  default: revenue
                  description: Sort criteria
                  example: "revenue"
                start_date:
                  type: string
                  format: date
                  description: Start date for analysis (defaults to 30 days ago)
                  example: "2024-12-15"
                end_date:
                  type: string
                  format: date
                  description: End date for analysis (defaults to today)
                  example: "2025-01-15"
      responses:
        '200':
          description: Best selling products
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        rank:
                          type: integer
                          example: 1
                        product_id:
                          type: string
                          format: uuid
                        product_name:
                          type: string
                          example: "Kopi Susu"
                        sku:
                          type: string
                          example: "KOP-001"
                        category:
                          type: string
                          example: "Beverages"
                        units_sold:
                          type: integer
                          example: 150
                        revenue:
                          type: number
                          format: float
                          example: 750000
                        profit_margin:
                          type: number
                          format: float
                          nullable: true
                          description: Profit margin percentage (for recipe-based products only)
                          example: 65.5
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/cashier-performance:
    post:
      tags: [POS Analytics]
      summary: Get cashier performance metrics
      description: |
        Returns performance metrics for all cashiers including:
        - Transactions handled
        - Revenue generated
        - Average transaction time
      operationId: getCashierPerformance
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                start_date:
                  type: string
                  format: date
                  description: Start date for analysis (defaults to 30 days ago)
                  example: "2024-12-15"
                end_date:
                  type: string
                  format: date
                  description: End date for analysis (defaults to today)
                  example: "2025-01-15"
      responses:
        '200':
          description: Cashier performance metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        cashier_id:
                          type: string
                          format: uuid
                        cashier_name:
                          type: string
                          example: "John Doe"
                        transactions_handled:
                          type: integer
                          example: 245
                        revenue_generated:
                          type: number
                          format: float
                          example: 35000000
                        average_transaction_time:
                          type: number
                          format: float
                          description: Average time per transaction in seconds
                          example: 120.5
                        average_ticket:
                          type: number
                          format: float
                          example: 142857.14
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/material-costs:
    post:
      tags: [POS Analytics]
      summary: Analyze material costs for products (Phase 4A Day 5)
      description: |
        Calculates profit margins and material costs for recipe-based products.
        Used in POS cart to show real-time profitability.
        Returns detailed cost breakdown including material components.
      operationId: getMaterialCosts
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - products
              properties:
                products:
                  type: array
                  description: List of products to analyze
                  items:
                    type: object
                    required:
                      - product_id
                      - quantity
                    properties:
                      product_id:
                        type: string
                        format: uuid
                        description: Product UUID
                        example: "9d3e8f12-a4b5-4c6d-8e9f-0123456789ab"
                      quantity:
                        type: integer
                        minimum: 1
                        description: Quantity to analyze
                        example: 2
                      selling_price:
                        type: number
                        format: float
                        description: Override selling price (optional, uses product price if not provided)
                        example: 15000
            example:
              products:
                - product_id: "9d3e8f12-a4b5-4c6d-8e9f-0123456789ab"
                  quantity: 2
                  selling_price: 15000
                - product_id: "8c2d7e11-b3a4-5b7c-9d8e-f123456789cd"
                  quantity: 1
      responses:
        '200':
          description: Material cost analysis
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      products:
                        type: array
                        items:
                          type: object
                          properties:
                            product_id:
                              type: string
                              format: uuid
                            product_name:
                              type: string
                              example: "Kopi Susu"
                            sku:
                              type: string
                              example: "KOP-001"
                            quantity:
                              type: integer
                              example: 2
                            selling_price:
                              type: number
                              format: float
                              example: 15000
                            has_recipe:
                              type: boolean
                              description: Whether product has active recipe
                              example: true
                            material_cost_per_unit:
                              type: number
                              format: float
                              description: Material cost per single unit
                              example: 5200
                            total_material_cost:
                              type: number
                              format: float
                              description: Total material cost (cost_per_unit * quantity)
                              example: 10400
                            total_selling_price:
                              type: number
                              format: float
                              description: Total selling price (selling_price * quantity)
                              example: 30000
                            profit_amount:
                              type: number
                              format: float
                              description: Profit in currency
                              example: 19600
                            profit_margin:
                              type: number
                              format: float
                              description: Profit margin percentage
                              example: 65.33
                            material_breakdown:
                              type: array
                              description: Detailed breakdown of material costs
                              items:
                                type: object
                                properties:
                                  material_id:
                                    type: string
                                    format: uuid
                                  material_name:
                                    type: string
                                    example: "Kopi Bubuk"
                                  quantity_required:
                                    type: number
                                    format: float
                                    example: 15
                                  waste_percentage:
                                    type: number
                                    format: float
                                    example: 5
                                  effective_quantity:
                                    type: number
                                    format: float
                                    description: Quantity including waste
                                    example: 15.75
                                  unit:
                                    type: string
                                    example: "gram"
                                  unit_cost:
                                    type: number
                                    format: float
                                    example: 190.48
                                  component_cost:
                                    type: number
                                    format: float
                                    description: Total cost for this component
                                    example: 3000
                            alert:
                              type: object
                              nullable: true
                              description: Alert if profit margin is low
                              properties:
                                type:
                                  type: string
                                  enum: [warning, error]
                                  example: "warning"
                                message:
                                  type: string
                                  example: "Warning: Low profit margin (below 30%)"
                      summary:
                        type: object
                        description: Overall transaction summary
                        properties:
                          total_cost:
                            type: number
                            format: float
                            description: Total material cost for all products
                            example: 10400
                          total_revenue:
                            type: number
                            format: float
                            description: Total revenue for all products
                            example: 30000
                          total_profit:
                            type: number
                            format: float
                            description: Total profit (revenue - cost)
                            example: 19600
                          overall_profit_margin:
                            type: number
                            format: float
                            description: Overall profit margin percentage
                            example: 65.33
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant or Product not found
        '422':
          description: Validation error

  /tenants/{tenantId}/analytics/pos/forecast:
    post:
      tags: [POS Analytics]
      summary: Generate sales forecast
      description: |
        Phase 5: Backend-powered forecasting using statistical algorithms.
        Generates revenue/transaction forecasts for future dates.
      operationId: postPosForecast
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                metric_type:
                  type: string
                  enum: [revenue, transactions, average_ticket]
                  default: revenue
                  description: Metric to forecast
                  example: "revenue"
                days_ahead:
                  type: integer
                  minimum: 1
                  maximum: 365
                  default: 30
                  description: Number of days to forecast
                  example: 30
                algorithm:
                  type: string
                  enum: [linear_regression, exponential_smoothing]
                  default: linear_regression
                  description: Forecasting algorithm to use
                  example: "linear_regression"
      responses:
        '200':
          description: Forecast generated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      forecasts:
                        type: array
                        items:
                          type: object
                          properties:
                            predicted_date:
                              type: string
                              format: date
                              example: "2025-02-15"
                            predicted_value:
                              type: number
                              format: float
                              example: 12800000
                            confidence_lower:
                              type: number
                              format: float
                              description: 95% confidence interval lower bound
                              example: 11500000
                            confidence_upper:
                              type: number
                              format: float
                              description: 95% confidence interval upper bound
                              example: 14100000
                      r_squared:
                        type: number
                        format: float
                        description: Goodness of fit (0-1), higher is better
                        example: 0.87
                      algorithm:
                        type: string
                        example: "linear_regression"
                      historical_days_used:
                        type: integer
                        description: Number of historical days used in calculation
                        example: 90
        '400':
          description: Bad request - Invalid parameters
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/anomalies/detect:
    post:
      tags: [POS Analytics]
      summary: Run anomaly detection
      description: |
        Phase 5: Detect anomalies (spikes, drops) using Z-Score analysis.
        Compares actual values against expected values based on rolling window.
      operationId: postPosAnomaliesDetect
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                start_date:
                  type: string
                  format: date
                  description: Start date for analysis (defaults to yesterday)
                  example: "2025-01-01"
                end_date:
                  type: string
                  format: date
                  description: End date for analysis (defaults to today)
                  example: "2025-01-26"
                metric_type:
                  type: string
                  enum: [revenue, transactions, average_ticket]
                  default: revenue
                  description: Metric to analyze
                  example: "revenue"
      responses:
        '200':
          description: Anomalies detected and stored
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      anomalies:
                        type: array
                        items:
                          $ref: '#/components/schemas/Anomaly'
                      total_count:
                        type: integer
                        description: Number of anomalies detected
                        example: 3
        '400':
          description: Bad request
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/anomalies:
    get:
      tags: [POS Analytics]
      summary: Get historical anomalies
      description: |
        Phase 5: Retrieve stored anomalies with filtering and pagination.
      operationId: getPosAnomalies
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
        - name: start_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter by detected date (start)
          example: "2025-01-01"
        - name: end_date
          in: query
          required: false
          schema:
            type: string
            format: date
          description: Filter by detected date (end)
          example: "2025-01-26"
        - name: severity
          in: query
          required: false
          schema:
            type: string
            enum: [low, medium, high, critical]
          description: Filter by severity
          example: "high"
        - name: acknowledged
          in: query
          required: false
          schema:
            type: boolean
          description: Filter by acknowledgment status
          example: false
        - name: metric_type
          in: query
          required: false
          schema:
            type: string
            enum: [revenue, transactions, average_ticket]
          description: Filter by metric type
          example: "revenue"
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: Page number
          example: 1
        - name: per_page
          in: query
          required: false
          schema:
            type: integer
            default: 20
            minimum: 1
            maximum: 100
          description: Results per page
          example: 20
      responses:
        '200':
          description: List of anomalies
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Anomaly'
                  meta:
                    type: object
                    properties:
                      current_page:
                        type: integer
                        example: 1
                      from:
                        type: integer
                        example: 1
                      last_page:
                        type: integer
                        example: 3
                      per_page:
                        type: integer
                        example: 20
                      to:
                        type: integer
                        example: 20
                      total:
                        type: integer
                        example: 47
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

  /tenants/{tenantId}/analytics/pos/anomalies/{anomalyId}/acknowledge:
    post:
      tags: [POS Analytics]
      summary: Acknowledge an anomaly
      description: |
        Phase 5: Mark an anomaly as acknowledged by current user.
      operationId: postPosAnomalyAcknowledge
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
        - name: anomalyId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Anomaly ID
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
      responses:
        '200':
          description: Anomaly acknowledged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Anomaly'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Anomaly not found

  /tenants/{tenantId}/analytics/pos/preferences:
    get:
      tags: [POS Analytics]
      summary: Get analytics preferences
      description: |
        Phase 5: Get user or tenant-wide analytics preferences.
      operationId: getPosPreferences
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      responses:
        '200':
          description: Analytics preferences
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/AnalyticsPreferences'
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Preferences not found
    
    put:
      tags: [POS Analytics]
      summary: Update analytics preferences
      description: |
        Phase 5: Update user analytics preferences.
      operationId: putPosPreferences
      security:
        - bearerAuth: []
      parameters:
        - $ref: ../components/parameters/common.yaml#/TenantId
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                anomaly_window_days:
                  type: integer
                  minimum: 3
                  maximum: 90
                  description: Rolling window size for anomaly detection
                  example: 7
                anomaly_threshold_low:
                  type: number
                  format: float
                  minimum: 1.0
                  maximum: 5.0
                  description: Z-score threshold for low severity
                  example: 1.5
                anomaly_threshold_medium:
                  type: number
                  format: float
                  minimum: 1.0
                  maximum: 5.0
                  description: Z-score threshold for medium severity
                  example: 2.0
                anomaly_threshold_high:
                  type: number
                  format: float
                  minimum: 1.0
                  maximum: 5.0
                  description: Z-score threshold for high severity
                  example: 2.5
                anomaly_threshold_critical:
                  type: number
                  format: float
                  minimum: 1.0
                  maximum: 5.0
                  description: Z-score threshold for critical severity
                  example: 3.0
                forecast_days_ahead:
                  type: integer
                  minimum: 1
                  maximum: 365
                  description: Default forecast horizon
                  example: 30
                forecast_algorithm:
                  type: string
                  enum: [linear_regression, exponential_smoothing]
                  description: Default forecasting algorithm
                  example: "linear_regression"
                email_notifications_enabled:
                  type: boolean
                  description: Enable email notifications for anomalies
                  example: true
                notification_severity_filter:
                  type: array
                  items:
                    type: string
                    enum: [low, medium, high, critical]
                  description: Which severity levels trigger notifications
                  example: ["high", "critical"]
                notification_digest_frequency:
                  type: string
                  enum: [realtime, daily, weekly]
                  description: Notification frequency
                  example: "daily"
                benchmark_baseline_days:
                  type: integer
                  minimum: 7
                  maximum: 365
                  description: Days to use for benchmark calculations
                  example: 30
      responses:
        '200':
          description: Preferences updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/AnalyticsPreferences'
        '400':
          description: Bad request - Validation error
        '401':
          description: Unauthorized
        '403':
          description: Forbidden
        '404':
          description: Tenant not found

components:
  schemas:
    Anomaly:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"
        tenant_id:
          type: string
          format: uuid
          example: "11111111-1111-1111-1111-111111111111"
        detected_date:
          type: string
          format: date
          example: "2025-01-25"
        metric_type:
          type: string
          enum: [revenue, transactions, average_ticket]
          example: "revenue"
        anomaly_type:
          type: string
          enum: [spike, drop, flat]
          example: "drop"
        severity:
          type: string
          enum: [low, medium, high, critical]
          example: "high"
        actual_value:
          type: number
          format: float
          example: 8500000
        expected_value:
          type: number
          format: float
          example: 12000000
        variance_percent:
          type: number
          format: float
          description: Percentage difference from expected
          example: -29.17
        z_score:
          type: number
          format: float
          description: Statistical z-score
          example: -2.8
        context_data:
          type: string
          nullable: true
          description: JSON string with additional context
          example: '{"window_size":7,"std_dev":1200000}'
        acknowledged:
          type: boolean
          example: false
        acknowledged_by:
          type: string
          format: uuid
          nullable: true
          example: null
        acknowledged_at:
          type: string
          format: date-time
          nullable: true
          example: null
        created_at:
          type: string
          format: date-time
          example: "2025-01-26T08:30:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-26T08:30:00Z"
    
    AnalyticsPreferences:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: "b2c3d4e5-f6g7-8901-bcde-f12345678901"
        tenant_id:
          type: string
          format: uuid
          example: "11111111-1111-1111-1111-111111111111"
        user_id:
          type: string
          format: uuid
          nullable: true
          description: NULL means tenant-wide default
          example: null
        anomaly_window_days:
          type: integer
          example: 7
        anomaly_threshold_low:
          type: number
          format: float
          example: 1.5
        anomaly_threshold_medium:
          type: number
          format: float
          example: 2.0
        anomaly_threshold_high:
          type: number
          format: float
          example: 2.5
        anomaly_threshold_critical:
          type: number
          format: float
          example: 3.0
        forecast_days_ahead:
          type: integer
          example: 30
        forecast_algorithm:
          type: string
          example: "linear_regression"
        email_notifications_enabled:
          type: boolean
          example: true
        notification_severity_filter:
          type: array
          items:
            type: string
          example: ["high", "critical"]
        notification_digest_frequency:
          type: string
          example: "daily"
        benchmark_baseline_days:
          type: integer
          example: 30
        created_at:
          type: string
          format: date-time
          example: "2025-01-26T00:00:00Z"
        updated_at:
          type: string
          format: date-time
          example: "2025-01-26T00:00:00Z"